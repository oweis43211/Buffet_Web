<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام البوفيه</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ========= CSS كامل ========= */
        body { font-family: 'Cairo', sans-serif; margin:0; padding:0; background:#121212; color:white; }
        .screen { display: block; }
        .hidden { display: none; }
        .login-container, .app-container { max-width: 1200px; margin:auto; padding:20px; }
        h1,h2,h3,h4 { margin:0; }
        button { cursor:pointer; }
        .btn-primary { background:#00bfa6; color:white; border:none; padding:10px 20px; border-radius:5px; }
        .btn-secondary { background:#555; color:white; border:none; padding:10px 20px; border-radius:5px; }
        .btn-cash { background:#fbc02d; color:white; border:none; padding:10px 20px; border-radius:5px; }
        .message { margin-top:10px; padding:10px; border-radius:5px; }
        .message.error { background:#f44336; color:white; }
        .message.success { background:#4caf50; color:white; }
        .notification-area { position:fixed; top:20px; right:20px; z-index:1000; display:flex; flex-direction:column; gap:10px; }
        .notification { background:#333; color:white; padding:15px 20px; border-radius:5px; display:flex; justify-content:space-between; align-items:center; }
        .notification.info { background:#2196f3; }
        .notification.success { background:#4caf50; }
        .notification.error { background:#f44336; }
        .notification-close { background:none; border:none; color:white; font-size:18px; cursor:pointer; }
        /* ========== Admin CSS ========== */
        .admin-layout { display:grid; grid-template-columns:250px 1fr; gap:20px; margin-top:20px; }
        .admin-sidebar { background:rgba(30,30,30,0.9); border-radius:10px; padding:20px; }
        .sidebar-menu { display:flex; flex-direction:column; gap:10px; }
        .menu-item { display:flex; align-items:center; gap:15px; padding:15px; background:rgba(255,255,255,0.05); border:none; border-radius:10px; color:#aaa; font-size:16px; cursor:pointer; transition:0.3s; }
        .menu-item:hover { background:rgba(255,255,255,0.1); color:white; }
        .menu-item.active { background:#00bfa6; color:white; }
        .menu-item i { font-size:18px; }
        .admin-content { background:rgba(30,30,30,0.9); border-radius:10px; padding:30px; overflow-x:auto; }
        /* --------- Responsive --------- */
        @media (max-width:1024px){ .admin-layout{grid-template-columns:1fr;} .sidebar-menu{flex-direction:row;overflow-x:auto;padding-bottom:10px;} .menu-item{min-width:150px;white-space:nowrap;} }
        @media (max-width:768px){ .stats-grid,.charts-grid,.top-section,.settings-cards{grid-template-columns:1fr;} .admin-content{padding:15px;} }
        /* ========= باقي CSS المكونات ========= */
        .product-card { background:#1e1e1e; border-radius:10px; padding:10px; display:flex; flex-direction:column; align-items:center; gap:10px; margin-bottom:15px; }
        .product-image { width:100%; height:150px; object-fit:cover; border-radius:5px; }
        .product-info { text-align:center; }
        .product-actions { display:flex; gap:10px; }
        .qty-controls button { width:30px; height:30px; border:none; background:#444; color:white; border-radius:5px; }
        .cart-items .cart-item { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .cart-item-remove { background:none; border:none; color:#f44336; font-size:18px; cursor:pointer; }
    </style>
</head>
<body>
    <!-- ========= HTML كامل ========= -->
    <div id="adminBtn" class="admin-btn"><i class="fas fa-cog"></i></div>
    
    <div id="loginScreen" class="screen">
        <div class="login-container">
            <div class="app-header">
                <h1><i class="fas fa-utensils"></i> نظام البوفيه الذكي</h1>
                <p>نظام طلبات الطعام والمشروبات</p>
            </div>
            <div class="login-form">
                <h2><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</h2>
                <div class="form-group">
                    <label for="username"><i class="fas fa-user"></i> اسم المستخدم:</label>
                    <input type="text" id="username" placeholder="أدخل اسم المستخدم">
                </div>
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> كلمة المرور:</label>
                    <input type="password" id="password" placeholder="أدخل كلمة المرور (4 أرقام)">
                </div>
                <button id="loginBtn" class="btn-primary"><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</button>
                <button id="changePasswordBtn" class="btn-secondary"><i class="fas fa-key"></i> تغيير كلمة المرور</button>
                <div id="loginMessage" class="message"></div>
            </div>
        </div>
    </div>
    
    <div id="mainScreen" class="screen hidden">
        <div class="app-container">
            <header class="app-header">
                <div class="header-content">
                    <h1><i class="fas fa-utensils"></i> نظام البوفيه الذكي</h1>
                    <div class="user-info">
                        <span id="userName">المستخدم</span>
                        <button id="logoutBtn" class="btn-logout"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
                    </div>
                </div>
                <div class="system-info">
                    <div class="status-item"><i class="fas fa-store"></i> <span id="buffetStatus">جاري التحميل...</span></div>
                    <div class="status-item"><i class="fas fa-clock"></i> <span id="lastUpdate">آخر تحديث: --:--:--</span></div>
                </div>
            </header>
            <main class="main-content">
                <div class="order-section">
                    <div class="section-header"><h2><i class="fas fa-shopping-cart"></i> طلب جديد</h2></div>
                    <div class="order-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="place"><i class="fas fa-map-marker-alt"></i> مكانك:</label>
                                <input type="text" id="place" placeholder="الغرفة / المكتب">
                            </div>
                            <div class="form-group">
                                <label for="note"><i class="fas fa-sticky-note"></i> ملاحظة (اختياري):</label>
                                <textarea id="note" rows="2" placeholder="ملاحظات إضافية للطلب..."></textarea>
                            </div>
                        </div>
                        <div class="cart-summary">
                            <h3><i class="fas fa-shopping-basket"></i> سلة المشتريات</h3>
                            <div id="cartItems" class="cart-items"><p class="empty-cart">السلة فارغة</p></div>
                            <div class="cart-total"><span>المجموع:</span> <span id="cartTotal">0.00 جنيه</span></div>
                            <div class="cart-actions">
                                <button id="clearCartBtn" class="btn-secondary"><i class="fas fa-trash"></i> إفراغ السلة</button>
                                <button id="sendOrderBtn" class="btn-primary"><i class="fas fa-paper-plane"></i> إرسال الطلب (عادي)</button>
                                <button id="sendCashOrderBtn" class="btn-cash"><i class="fas fa-money-bill-wave"></i> إرسال الطلب (كاش)</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="products-section">
                    <div class="section-header">
                        <h2><i class="fas fa-boxes"></i> المنتجات المتاحة</h2>
                        <div class="search-box"><i class="fas fa-search"></i><input type="text" id="productSearch" placeholder="البحث عن منتج..."></div>
                    </div>
                    <div class="category-tabs">
                        <button class="tab-btn active" data-category="all">كل المنتجات</button>
                        <button class="tab-btn" data-category="drinks">المشروبات</button>
                        <button class="tab-btn" data-category="foods">المأكولات</button>
                    </div>
                    <div id="productsGrid" class="products-grid"><div class="loading">جاري تحميل المنتجات...</div></div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="notificationArea" class="notification-area"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        /* ========= JavaScript كامل ========= */
        const SUPABASE_URL = "https://oshbvczwsxpimyneudeg.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let state = { loggedIn:false, username:null, selectedProducts:{}, products:[], availability:{}, orders:[], consumption:[], systemStatus:{ buffet_open:true, prayer_closed:false }, cart:[] };

        const elements = {
            loginScreen: document.getElementById('loginScreen'),
            mainScreen: document.getElementById('mainScreen'),
            adminBtn: document.getElementById('adminBtn'),
            usernameInput: document.getElementById('username'),
            passwordInput: document.getElementById('password'),
            loginBtn: document.getElementById('loginBtn'),
            changePasswordBtn: document.getElementById('changePasswordBtn'),
            loginMessage: document.getElementById('loginMessage'),
            userName: document.getElementById('userName'),
            logoutBtn: document.getElementById('logoutBtn'),
            buffetStatus: document.getElementById('buffetStatus'),
            lastUpdate: document.getElementById('lastUpdate'),
            place: document.getElementById('place'),
            note: document.getElementById('note'),
            cartItems: document.getElementById('cartItems'),
            cartTotal: document.getElementById('cartTotal'),
            clearCartBtn: document.getElementById('clearCartBtn'),
            sendOrderBtn: document.getElementById('sendOrderBtn'),
            sendCashOrderBtn: document.getElementById('sendCashOrderBtn'),
            productSearch: document.getElementById('productSearch'),
            productsGrid: document.getElementById('productsGrid')
        };

        let currentCategory = 'all';

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            const savedUser = localStorage.getItem('buffet_user');
            const savedUsername = localStorage.getItem('buffet_username');
            if(savedUser && savedUsername){ state.loggedIn=true; state.username=savedUsername; showMainScreen(); }else{ showLoginScreen(); }
        }

        function setupEventListeners() {
            elements.loginBtn.addEventListener('click', handleLogin);
            elements.logoutBtn.addEventListener('click', handleLogout);
            elements.clearCartBtn.addEventListener('click', clearCart);
            elements.sendOrderBtn.addEventListener('click', ()=>sendOrder('عادي'));
            elements.sendCashOrderBtn.addEventListener('click', ()=>sendOrder('كاش'));
            elements.productSearch.addEventListener('input', renderProducts);
        }

        async function handleLogin() {
            const username = elements.usernameInput.value.trim();
            const password = elements.passwordInput.value.trim();
            if(!username || !password){ showMessage(elements.loginMessage,'يرجى إدخال اسم المستخدم وكلمة المرور','error'); return; }
            if(!password.match(/^\d{4}$/)){ showMessage(elements.loginMessage,'كلمة المرور يجب أن تكون 4 أرقام فقط','error'); return; }

            try{
                const { data,error } = await supabase.from('users').select('*').eq('username',username).eq('password',password).single();
                if(error || !data){ showMessage(elements.loginMessage,'اسم المستخدم أو كلمة المرور غير صحيحة','error'); return; }
                state.loggedIn=true; state.username=username;
                localStorage.setItem('buffet_user', password); localStorage.setItem('buffet_username', username);
                showMainScreen(); loadUserData(); showNotification('تم تسجيل الدخول بنجاح!','success');
            }catch(err){ showMessage(elements.loginMessage,'حدث خطأ أثناء تسجيل الدخول','error'); console.error(err); }
        }

        function handleLogout(){ state.loggedIn=false; state.username=null; state.selectedProducts={}; state.cart=[]; localStorage.removeItem('buffet_user'); localStorage.removeItem('buffet_username'); showLoginScreen(); showNotification('تم تسجيل الخروج بنجاح','success'); }

        function showLoginScreen(){ elements.loginScreen.classList.remove('hidden'); elements.mainScreen.classList.add('hidden'); }
        function showMainScreen(){ elements.loginScreen.classList.add('hidden'); elements.mainScreen.classList.remove('hidden'); }
        function showMessage(element,text,type){ element.textContent=text; element.className=`message ${type}`; }
        function showNotification(text,type='info'){ const notificationArea=document.getElementById('notificationArea'); const notification=document.createElement('div'); notification.className=`notification ${type}`; notification.innerHTML=`<div class="notification-content">${text}</div><button class="notification-close" onclick="this.parentElement.remove()">&times;</button>`; notificationArea.appendChild(notification); setTimeout(()=>{if(notification.parentElement){notification.remove();}},5000); }
    </script>
</body>
</html>
